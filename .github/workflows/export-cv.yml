name: Generate CV PDF

on:
  push:
    paths:
      - docs/cv.md
      - docs/resume.yaml
      - .github/workflows/export-cv.yml
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Pandoc + XeLaTeX (with CJK support)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-lang-cjk \
            fonts-noto \
            fonts-noto-cjk \
            lmodern
          echo "Pandoc version: $(pandoc -v | head -n1)"
          xelatex --version | head -n1

      - name: Build PDF with Pandoc
        run: |
          mkdir -p docs
          pandoc docs/cv.md \
            --pdf-engine=xelatex \
            --metadata-file=docs/config/resume.yaml \
            -V mainfont="Noto Sans" \
            -V sansfont="Noto Sans" \
            -V monofont="Noto Sans Mono" \
            -V CJKmainfont="Noto Sans CJK JP" \
            -o docs/cv.pdf

          echo "PDF generated at docs/cv.pdf"

      - name: Commit & push PDF if threre are changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(cv): update docs/cv.pdf"
          file_pattern: docs/cv.pdf

      - name: Upload PDF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cv-pdf
          path: docs/cv.pdf
